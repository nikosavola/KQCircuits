

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>kqcircuits.simulations.export.gmsh_helpers &mdash; KQCircuits  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/logo.svg"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> KQCircuits
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../start/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../user_guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../libraries/index.html">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/kqcircuits.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trademarks.html">Trademarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">KQCircuits</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>kqcircuits.simulations.export.gmsh_helpers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for kqcircuits.simulations.export.gmsh_helpers</h1><div class="highlight"><pre>
<span></span><span class="c1"># This code is part of KQCircuits</span>
<span class="c1"># Copyright (C) 2022 IQM Finland Oy</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public</span>
<span class="c1"># License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later</span>
<span class="c1"># version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<span class="c1"># warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License along with this program. If not, see</span>
<span class="c1"># https://www.gnu.org/licenses/gpl-3.0.html.</span>
<span class="c1">#</span>
<span class="c1"># The software distribution should follow IQM trademark policy for open-source software</span>
<span class="c1"># (meetiqm.com/developers/osstmpolicy). IQM welcomes contributions to the code. Please see our contribution agreements</span>
<span class="c1"># for individuals (meetiqm.com/developers/clas/individual) and organizations (meetiqm.com/developers/clas/organization).</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">gmsh</span>
<span class="kn">from</span> <span class="nn">kqcircuits.simulations.simulation</span> <span class="kn">import</span> <span class="n">Simulation</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="coord_dist"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.coord_dist">[docs]</a><span class="k">def</span> <span class="nf">coord_dist</span><span class="p">(</span><span class="n">coord1</span><span class="p">:</span> <span class="p">[],</span> <span class="n">coord2</span><span class="p">:</span> <span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the distance of two points based on two coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        coord1(list(float)): coordinates (x, y, z) of point 1.</span>
<span class="sd">        coord2(list(float)): coordinates (x, y, z) of point 2.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (float): distance between point 1 and 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                  <span class="p">(</span><span class="n">coord1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">coord2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">coord1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">coord2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">coord1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">coord2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="add_polygon"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.add_polygon">[docs]</a><span class="k">def</span> <span class="nf">add_polygon</span><span class="p">(</span><span class="n">point_coordinates</span><span class="p">:</span> <span class="p">[],</span> <span class="n">mesh_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the geometry entities in the OpenCASCADE model for generating a polygon and keeps track of all the entities.</span>
<span class="sd">    Returns the geometry entity ids.</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coordinates(list(float)):</span>
<span class="sd">            list of coordinates that make up the polygon (when lines are drawn betwee each concecutive points)</span>
<span class="sd">        mesh_size(float):</span>
<span class="sd">            mesh size can be given to the points (note that these points are not used in the final mesh</span>
<span class="sd">            in case the boolean operations are used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list()): list of entity ids</span>
<span class="sd">            * point_ids(list(int)): entity ids of each point used in the polygon</span>
<span class="sd">            * line_ids(list(int)): entity ids of each line used in the polygon</span>
<span class="sd">            * curve_loop_ids(list(int)): entity ids of each curveloop used in the polygon</span>
<span class="sd">            * plane_surface_id(int): entity id of the polygon</span>

<span class="sd">        Note that all of the ids become obsolete when boolean operations are used in OpenCASCADE kernel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curve_loop_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point_coordinates</span><span class="p">):</span>
        <span class="n">point_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">point_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">curve_loop_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">(</span><span class="n">line_ids</span><span class="p">))</span>
    <span class="n">plane_surface_id</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">(</span><span class="n">curve_loop_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">point_ids</span><span class="p">,</span> <span class="n">line_ids</span><span class="p">,</span> <span class="n">curve_loop_ids</span><span class="p">,</span> <span class="n">plane_surface_id</span></div>

<div class="viewcode-block" id="add_polygon_with_splines"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.add_polygon_with_splines">[docs]</a><span class="k">def</span> <span class="nf">add_polygon_with_splines</span><span class="p">(</span><span class="n">point_coordinates</span><span class="p">:</span> <span class="p">[],</span> <span class="n">mesh_size</span><span class="p">:</span> <span class="p">[],</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the geometry entities in the OpenCASCADE model for generating a polygon and keeps track of all the entities.</span>
<span class="sd">    Returns the geometry entity ids. This method is similar to `add_polygon`. The only difference is that if the</span>
<span class="sd">    distance between two concecutive points &lt; tol, then a spline is generated instead of line. But then ofcourse, there</span>
<span class="sd">    should be more than two points. Otherwise the result is the same. If spline is used for a trace of points, compared</span>
<span class="sd">    to lines, this makes it easier for the mesher to find a sensible mesh if the points are very close to each other.</span>

<span class="sd">    Args:</span>
<span class="sd">        point_coordinates(list((float, float, float))): list of coordinates that make up the polygon (when lines are</span>
<span class="sd">        drawn between each concecutive points)</span>
<span class="sd">        mesh_size(float): mesh size can be given to the points (note that these points are not used in the final mesh in</span>
<span class="sd">                          case the boolean operations are used.</span>
<span class="sd">        tol(float): tolerance for spline generation (if the distance between two concecutive points is smaller, use</span>
<span class="sd">                    spline instead of line)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (list): list of entity ids</span>
<span class="sd">            * point_ids(list(int)): entity ids of each point used in the polygon</span>
<span class="sd">            * line_ids(list(int)): entity ids of each line used in the polygon</span>
<span class="sd">            * curve_loop_ids(list(int)): entity ids of each curveloop used in the polygon</span>
<span class="sd">            * plane_surface_id(int): entity id of the polygon</span>

<span class="sd">        Note that all of the ids become obsolete when boolean operations are used in OpenCASCADE kernel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curve_loop_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spline_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spline</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point_coordinates</span><span class="p">):</span>
        <span class="n">point_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">*</span><span class="n">coord</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">))</span>
        <span class="n">point_id</span> <span class="o">=</span> <span class="n">point_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spline_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">coord1</span> <span class="o">=</span> <span class="n">point_coordinates</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">coord2</span> <span class="o">=</span> <span class="n">point_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spline</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coord_dist</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">spline</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">spline_points</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spline_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addSpline</span><span class="p">(</span><span class="n">spline_points</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">spline_points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spline_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">spline_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coord_dist</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="n">spline</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">spline_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">point_id</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spline_points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># in case spline and the last point distance &lt; tol</span>
        <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addSpline</span><span class="p">(</span><span class="n">spline_points</span><span class="p">))</span>

    <span class="n">line_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">point_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">point_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">curve_loop_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">(</span><span class="n">line_ids</span><span class="p">))</span>
    <span class="n">plane_surface_id</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">(</span><span class="n">curve_loop_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">point_ids</span><span class="p">,</span> <span class="n">line_ids</span><span class="p">,</span> <span class="n">curve_loop_ids</span><span class="p">,</span> <span class="n">plane_surface_id</span></div>

<div class="viewcode-block" id="add_shape_polygons"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.add_shape_polygons">[docs]</a><span class="k">def</span> <span class="nf">add_shape_polygons</span><span class="p">(</span><span class="n">simulation</span><span class="p">:</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">face_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">z_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create all polygons in a layer using `add_polygon_with_splines` according to the hull of each KLayout shape.</span>
<span class="sd">    Returns the so called list of dim_tags of all the created polygons which can be used to refer to the shapes later.</span>

<span class="sd">    Args:</span>
<span class="sd">        simulation(Simulation): KQC simulation object that contains all the polygons.</span>
<span class="sd">        face_id(int): KQC uses face ids to differenciate between different chips faces (for example in flip chip, 0 is</span>
<span class="sd">                      the bottom and 1 is the top).</span>
<span class="sd">        layer_name(str): the name of the layer to be created.</span>
<span class="sd">        z_level(float): the z-coordinate of the layer.</span>
<span class="sd">        mesh_size(float): mesh size can be given to the points (note that these points are not used in the final mesh in</span>
<span class="sd">                          case the boolean operations are used.</span>
<span class="sd">    Returns:</span>
<span class="sd">        hull_dim_tags(list(int, int)): dimTag (as called in Gmsh) is a tuple of</span>
<span class="sd">            * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">            * tag(int): the id of the entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">layout</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">face</span><span class="p">(</span><span class="n">face_id</span><span class="p">)[</span><span class="n">layer_name</span><span class="p">]))</span>
    <span class="n">hull_dim_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shapes</span><span class="o">.</span><span class="n">each</span><span class="p">():</span>
        <span class="n">hull_point_coordinates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">layout</span><span class="o">.</span><span class="n">dbu</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">layout</span><span class="o">.</span><span class="n">dbu</span><span class="p">,</span> <span class="n">z_level</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">each_point_hull</span><span class="p">()]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">hull_plane_surface_id</span> <span class="o">=</span> <span class="n">add_polygon_with_splines</span><span class="p">(</span><span class="n">hull_point_coordinates</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">)</span>
        <span class="n">hull_dim_tags</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">hull_plane_surface_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hull_dim_tags</span></div>

<div class="viewcode-block" id="create_face"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.create_face">[docs]</a><span class="k">def</span> <span class="nf">create_face</span><span class="p">(</span><span class="n">face_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">simulation</span><span class="p">:</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">mesh_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port_dim_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the face of a chip according to the &quot;simulation_ground&quot;, &quot;simulation_gap&quot; and &quot;simulation_signal&quot; layers</span>
<span class="sd">    using the `add_shape_polygons` method.</span>

<span class="sd">    Args:</span>
<span class="sd">        face_id(int): KQC uses face ids to differenciate between different chips faces (for example in flip chip, 0 is</span>
<span class="sd">            the bottom and 1 is the top).</span>
<span class="sd">        z_level(float): set the z-coordinate of the chip face.</span>
<span class="sd">        simulation(Simulation): KQC simulation object that contains all the polygons.</span>
<span class="sd">        mesh_sizes(dict): a mesh size can be given to the points:</span>

<span class="sd">            * ground(float): mesh size of the ground layer</span>
<span class="sd">            * ground_grid(float): mesh size of the ground grid layer</span>
<span class="sd">            * gap(float): mesh size of the gap layer</span>
<span class="sd">            * signal(float): mesh size of the signal layer</span>

<span class="sd">        port_dim_tags(list): list of DimTags of the port polygons</span>

<span class="sd">    Returns:</span>
<span class="sd">        tags(dict): a dictionary containing all the dim_tags of the created face:</span>
<span class="sd">            * ground(list(int, int)): a list of dim_tags belonging to the ground, dimTag is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">            * ground_grid(list(int, int)): a list of dim_tags belonging to the ground_grid, dimTag is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">            * gap(list(int, int)): a list of dim_tags belonging to the gap dimTag  is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">            * signal(list(int, int)): a list of dim_tags belonging to the signal dimTag is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">    Note that all of the mesh sizes become obsolete when boolean operations are used in OpenCASCADE kernel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mesh_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mesh_sizes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ground&#39;</span><span class="p">:</span> <span class="mf">200.</span><span class="p">,</span>
            <span class="s1">&#39;ground_grid&#39;</span><span class="p">:</span> <span class="mf">200.</span><span class="p">,</span>
            <span class="s1">&#39;gap&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">if</span> <span class="n">port_dim_tags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">port_dim_tags</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ground_hull_dim_tags</span> <span class="o">=</span> <span class="n">add_shape_polygons</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">face_id</span><span class="p">,</span> <span class="s2">&quot;simulation_ground&quot;</span><span class="p">,</span>
            <span class="n">z_level</span><span class="p">,</span> <span class="n">mesh_sizes</span><span class="p">[</span><span class="s1">&#39;ground&#39;</span><span class="p">])</span>
    <span class="n">ground_grid_hull_dim_tags</span> <span class="o">=</span> <span class="n">add_shape_polygons</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">face_id</span><span class="p">,</span> <span class="s2">&quot;ground_grid&quot;</span><span class="p">,</span>
            <span class="n">z_level</span><span class="p">,</span> <span class="n">mesh_sizes</span><span class="p">[</span><span class="s1">&#39;ground_grid&#39;</span><span class="p">])</span>
    <span class="n">gap_hull_dim_tags</span> <span class="o">=</span> <span class="n">add_shape_polygons</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">face_id</span><span class="p">,</span> <span class="s2">&quot;simulation_gap&quot;</span><span class="p">,</span>
            <span class="n">z_level</span><span class="p">,</span> <span class="n">mesh_sizes</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">])</span>
    <span class="n">signal_hull_dim_tags</span> <span class="o">=</span> <span class="n">add_shape_polygons</span><span class="p">(</span><span class="n">simulation</span><span class="p">,</span> <span class="n">face_id</span><span class="p">,</span> <span class="s2">&quot;simulation_signal&quot;</span><span class="p">,</span>
            <span class="n">z_level</span><span class="p">,</span> <span class="n">mesh_sizes</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_hull_dim_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gap_hull_dim_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_grid_hull_dim_tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">cutter</span> <span class="o">=</span> <span class="n">gap_hull_dim_tags</span> <span class="o">+</span> <span class="n">ground_grid_hull_dim_tags</span>
        <span class="n">ground_dim_tags</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">ground_hull_dim_tags</span><span class="p">,</span> <span class="n">cutter</span><span class="p">,</span> <span class="n">removeTool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cutter</span> <span class="o">=</span> <span class="n">signal_hull_dim_tags</span> <span class="o">+</span> <span class="n">port_dim_tags</span>
        <span class="n">gap_dim_tags</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">gap_hull_dim_tags</span><span class="p">,</span> <span class="n">cutter</span><span class="p">,</span> <span class="n">removeTool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ground_dim_tags</span> <span class="o">=</span> <span class="n">ground_hull_dim_tags</span>
        <span class="n">gap_dim_tags</span> <span class="o">=</span> <span class="n">gap_hull_dim_tags</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ground&#39;</span><span class="p">:</span> <span class="n">ground_dim_tags</span><span class="p">,</span>
        <span class="s1">&#39;gap&#39;</span><span class="p">:</span> <span class="n">gap_dim_tags</span><span class="p">,</span>
        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal_hull_dim_tags</span><span class="p">,</span>
        <span class="s1">&#39;ground_grid&#39;</span><span class="p">:</span> <span class="n">ground_grid_hull_dim_tags</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">tags</span></div>

<div class="viewcode-block" id="bounding_box_from_dim_tags"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.bounding_box_from_dim_tags">[docs]</a><span class="k">def</span> <span class="nf">bounding_box_from_dim_tags</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the bounding box of all the geometry entities refered to in dim_tags list.</span>

<span class="sd">    Args:</span>
<span class="sd">        dim_tags(list(int, int)):</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of:</span>
<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>
<span class="sd">    Returns:</span>
<span class="sd">        bounding_box(list()):</span>
<span class="sd">            * xminmin(float): minimum x-coordinate of all the bounding boxes</span>
<span class="sd">            * yminmin(float): minimum y-coordinate of all the bounding boxes</span>
<span class="sd">            * zminmin(float): minimum z-coordinate of all the bounding boxes</span>
<span class="sd">            * xmaxmax(float): maximum x-coordinate of all the bounding boxes</span>
<span class="sd">            * ymaxmax(float): maximum y-coordinate of all the bounding boxes</span>
<span class="sd">            * zmaxmax(float): maximum z-coordinate of all the bounding boxes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">):</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xminmin</span> <span class="o">=</span> <span class="n">xmin</span>
            <span class="n">yminmin</span> <span class="o">=</span> <span class="n">ymin</span>
            <span class="n">zminmin</span> <span class="o">=</span> <span class="n">zmin</span>
            <span class="n">xmaxmax</span> <span class="o">=</span> <span class="n">xmax</span>
            <span class="n">ymaxmax</span> <span class="o">=</span> <span class="n">ymax</span>
            <span class="n">zmaxmax</span> <span class="o">=</span> <span class="n">zmax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xminmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xminmin</span><span class="p">)</span>
            <span class="n">yminmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">yminmin</span><span class="p">)</span>
            <span class="n">zminmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zminmin</span><span class="p">)</span>
            <span class="n">xmaxmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmaxmax</span><span class="p">)</span>
            <span class="n">ymaxmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymaxmax</span><span class="p">)</span>
            <span class="n">zmaxmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">zmaxmax</span><span class="p">)</span>

    <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">xminmin</span><span class="p">,</span> <span class="n">yminmin</span><span class="p">,</span> <span class="n">zminmin</span><span class="p">,</span> <span class="n">xmaxmax</span><span class="p">,</span> <span class="n">ymaxmax</span><span class="p">,</span> <span class="n">zmaxmax</span>

    <span class="k">return</span> <span class="n">bounding_box</span></div>

<div class="viewcode-block" id="bounding_box_to_xyzdxdydz"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.bounding_box_to_xyzdxdydz">[docs]</a><span class="k">def</span> <span class="nf">bounding_box_to_xyzdxdydz</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">:</span> <span class="p">[],</span> <span class="n">dz</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a bounding box in a format that is compatible to generating a box.</span>

<span class="sd">    Args:</span>
<span class="sd">        bounding_box(list):</span>
<span class="sd">            * xmin(float): minimum x-coordinate of the bounding box</span>
<span class="sd">            * ymin(float): minimum y-coordinate of the bounding box</span>
<span class="sd">            * zmin(float): minimum z-coordinate of the bounding box</span>
<span class="sd">            * xmax(float): maximum x-coordinate of the bounding box</span>
<span class="sd">            * ymax(float): maximum y-coordinate of the bounding box</span>
<span class="sd">            * zmax(float): maximum z-coordinate of the bounding box</span>
<span class="sd">        dz(float): override the dz of the bounding box</span>
<span class="sd">    Returns:</span>
<span class="sd">        bounding_box(list):</span>
<span class="sd">            * xmin(float): minimum x-coordinate of the bounding box</span>
<span class="sd">            * ymin(float): minimum y-coordinate of the bounding box</span>
<span class="sd">            * zmin(float): minimum z-coordinate of the bounding box</span>
<span class="sd">            * dx(float): dx of the maximum x-coordinate of the bounding box with respect to xmin</span>
<span class="sd">            * dy(float): dy of the maximum y-coordinate of the bounding box with respect to ymin</span>
<span class="sd">            * dz(float): dz of the maximum z-coordinate of the bounding box with respect to zmin</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">bounding_box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span></div>

<div class="viewcode-block" id="substrate"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.substrate">[docs]</a><span class="k">def</span> <span class="nf">substrate</span><span class="p">(</span><span class="n">face_dim_tag_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dz</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a substrate that has fits the size of a created face and has the thickness of `dz`.</span>

<span class="sd">    Args:</span>
<span class="sd">        face_dim_tag_dict(dict):</span>
<span class="sd">            a dictionary containing all the dim_tags of the created face:</span>
<span class="sd">                * ground(list(int, int)): a list of dim_tags belonging to the ground, dimTag (as in Gmsh) is a tuple of</span>
<span class="sd">                    * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                    * tag(int): the id of the entity</span>

<span class="sd">                * gap(list(int, int)): a list of dim_tags belonging to the gap dimTag (as in Gmsh) is a tuple of</span>
<span class="sd">                    * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                    * tag(int): the id of the entity</span>

<span class="sd">                * signal(list(int, int)): a list of dim_tags belonging to the signal dimTag (as in Gmsh) is a tuple of</span>
<span class="sd">                    * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                    * tag(int): the id of the entity</span>

<span class="sd">        dz(float): chip thickness</span>
<span class="sd">    Returns:</span>
<span class="sd">        (int, int): dim_tag of the substrate volume with dim=3 and tag automatically generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">face_bounding_box</span> <span class="o">=</span> <span class="n">bounding_box_from_dim_tags</span><span class="p">(</span><span class="n">face_dim_tag_dict</span><span class="p">[</span><span class="s1">&#39;ground&#39;</span><span class="p">])</span>
    <span class="n">xyzdxdydz</span> <span class="o">=</span> <span class="n">bounding_box_to_xyzdxdydz</span><span class="p">(</span><span class="n">face_bounding_box</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="o">*</span><span class="n">xyzdxdydz</span><span class="p">,</span> <span class="n">tag</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="vacuum_between_faces"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.vacuum_between_faces">[docs]</a><span class="k">def</span> <span class="nf">vacuum_between_faces</span><span class="p">(</span><span class="n">face0_ground_dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">face1_ground_dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a vacuum between the faces 0 and 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        face0_ground_dim_tags(list(int, int)): a list of dim_tags belonging to the ground,</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of:</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">        face1_ground_dim_tags(list(int, int)): a list of dim_tags belonging to the ground,</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of:</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">    Returns:</span>
<span class="sd">        (int, int): dim_tag of the vacuum volume with dim=3 and tag automatically generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">bounding_box_from_dim_tags</span><span class="p">(</span><span class="n">face0_ground_dim_tags</span> <span class="o">+</span> <span class="n">face1_ground_dim_tags</span><span class="p">)</span>
    <span class="n">xyzdxdydz</span> <span class="o">=</span> <span class="n">bounding_box_to_xyzdxdydz</span><span class="p">(</span><span class="n">bounding_box</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="o">*</span><span class="n">xyzdxdydz</span><span class="p">,</span> <span class="n">tag</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="face_tag_dict_to_list"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.face_tag_dict_to_list">[docs]</a><span class="k">def</span> <span class="nf">face_tag_dict_to_list</span><span class="p">(</span><span class="n">face_dim_tag_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reorganize dim_tag dict into a list of dim_tags. Basically the point is to have all the geometric entities</span>
<span class="sd">    in the same list, regardless of their membership to certain layers.</span>

<span class="sd">    Args:</span>
<span class="sd">        face_dim_tag_dict(dict): a dictionary containing all the dim_tags of the created face:</span>

<span class="sd">            * ground(list(int, int)): a list of dim_tags belonging to the ground:</span>
<span class="sd">                    dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                        * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                        * tag(int): the id of the entity</span>

<span class="sd">            * ground_grid(list(int, int)): a list of dim_tags belonging to the ground_grid:</span>
<span class="sd">                    dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                        * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                        * tag(int): the id of the entity</span>

<span class="sd">            * gap(list(int, int)): a list of dim_tags belonging to the gap:</span>
<span class="sd">                    dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                        * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                        * tag(int): the id of the entity</span>

<span class="sd">            * signal(list(int, int)): a list of dim_tags belonging to the signal:</span>
<span class="sd">                    dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                        * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                        * tag(int): the id of the entity</span>
<span class="sd">    Returns:</span>
<span class="sd">        (list(int, int)): a list of dim_tags belonging to the the face:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="s1">&#39;ground_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;gap&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span>
    <span class="n">dim_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">dim_tags</span> <span class="o">+=</span> <span class="n">face_dim_tag_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dim_tags</span></div>

<div class="viewcode-block" id="get_bounding_boxes"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.get_bounding_boxes">[docs]</a><span class="k">def</span> <span class="nf">get_bounding_boxes</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return bounding boxes of entities defined by list of dim_tags.</span>

<span class="sd">    Args:</span>
<span class="sd">        dim_tags(list(int, int)): a list of dim_tags:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>
<span class="sd">    Returns:</span>
<span class="sd">        bboxes(list): list of bounding boxes</span>
<span class="sd">            (list): list of floats describing one bounding box</span>

<span class="sd">                * xmin(float): minimum x-coordinate of the bounding box</span>
<span class="sd">                * ymin(float): minimum y-coordinate of the bounding box</span>
<span class="sd">                * zmin(float): minimum z-coordinate of the bounding box</span>
<span class="sd">                * xmax(float): maximum x-coordinate of the bounding box</span>
<span class="sd">                * ymax(float): maximum y-coordinate of the bounding box</span>
<span class="sd">                * zmax(float): maximum z-coordinate of the bounding box</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">dim_tags</span><span class="p">:</span>
        <span class="n">bboxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bboxes</span></div>

<div class="viewcode-block" id="get_entities_in_bounding_boxes"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.get_entities_in_bounding_boxes">[docs]</a><span class="k">def</span> <span class="nf">get_entities_in_bounding_boxes</span><span class="p">(</span><span class="n">bboxes</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return list of dim_tags of entities in bounding boxes</span>

<span class="sd">    Args:</span>
<span class="sd">        bboxes(list): list of bounding boxes</span>

<span class="sd">            (list): list of floats describing one bounding box</span>

<span class="sd">                * xmin(float): minimum x-coordinate of the bounding box</span>
<span class="sd">                * ymin(float): minimum y-coordinate of the bounding box</span>
<span class="sd">                * zmin(float): minimum z-coordinate of the bounding box</span>
<span class="sd">                * xmax(float): maximum x-coordinate of the bounding box</span>
<span class="sd">                * ymax(float): maximum y-coordinate of the bounding box</span>
<span class="sd">                * zmax(float): maximum z-coordinate of the bounding box</span>

<span class="sd">        dim(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">        eps(float): this is added on top of each dimension of the bounding box (min and max) so that</span>
<span class="sd">                    everything that is in the box, is really taken into account even if there are some</span>
<span class="sd">                    numerical errors.</span>
<span class="sd">    Returns:</span>
<span class="sd">        out_dim_tags(list(int, int)): a list of dim_tags of the entities that were found:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_dim_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bboxes</span><span class="p">:</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="n">out_dim_tags</span> <span class="o">+=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getEntitiesInBoundingBox</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">eps</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">eps</span><span class="p">,</span> <span class="n">zmin</span> <span class="o">-</span> <span class="n">eps</span><span class="p">,</span>
                                                                <span class="n">xmax</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_dim_tags</span></div>

<div class="viewcode-block" id="set_mesh_size_use_bounding_box"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.set_mesh_size_use_bounding_box">[docs]</a><span class="k">def</span> <span class="nf">set_mesh_size_use_bounding_box</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the mesh size of those entities that are in the bounding box of entities defined by list of dim_tags.</span>

<span class="sd">    Args:</span>
<span class="sd">        dim_tags(list(int, int)): a list of dim_tags of the entities to define the bounding boxes:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">            mesh_size: the mesh size to be defined to the entities in the bounding boxes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">get_bounding_boxes</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">get_entities_in_bounding_boxes</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mesh_size</span><span class="p">)</span></div>

<div class="viewcode-block" id="produce_geometry_info_for_dim_tags"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.produce_geometry_info_for_dim_tags">[docs]</a><span class="k">def</span> <span class="nf">produce_geometry_info_for_dim_tags</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produce some geometry information for the dim_tags for identification purposes.</span>
<span class="sd">    Currently, center of mass and bounding box is computed.</span>

<span class="sd">    Args:</span>
<span class="sd">        dim_tags(list(int, int)): a list of dim_tags of the entities to define the bounding boxes:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">            mesh_size: the mesh size to be defined to the entities in the bounding boxes</span>
<span class="sd">    Returns:</span>
<span class="sd">        geom_info(dict): geometry info for identification purposes:</span>
<span class="sd">            * dim_tag_1(dict): dictionary for dim_tag_1</span>
<span class="sd">                * c_o_m(float): Center of mass for dim_tag_1</span>
<span class="sd">                * bbox(float): Bounding box for dim_tag_1</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>

<span class="sd">            * dim_tag_n(dict): dictionary for dim_tag_n</span>
<span class="sd">                * c_o_m(float): Center of mass for dim_tag_n</span>
<span class="sd">                * bbox(float): Bounding box for dim_tag_n</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">geom_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">dim_tags</span><span class="p">:</span>
        <span class="n">geom_info</span><span class="p">[</span><span class="n">dim_tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">geom_info</span><span class="p">[</span><span class="n">dim_tag</span><span class="p">][</span><span class="s1">&#39;c_o_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getCenterOfMass</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">)</span>
        <span class="n">geom_info</span><span class="p">[</span><span class="n">dim_tag</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">geom_info</span></div>

<div class="viewcode-block" id="map_dim_tags_to_outdim_tags"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.map_dim_tags_to_outdim_tags">[docs]</a><span class="k">def</span> <span class="nf">map_dim_tags_to_outdim_tags</span><span class="p">(</span><span class="n">geom_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a mapping from old dim_tags to dim_tags in the current model (typically after fragmentation when the old</span>
<span class="sd">    entities are removed). &quot;dimTag&quot; (as called in Gmsh) is a tuple of:</span>

<span class="sd">        * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">        * tag(int): the id of the entity</span>

<span class="sd">    Args:</span>
<span class="sd">        geom_info(dict): geometry info for identification purposes:</span>

<span class="sd">            * dim_tag_1(dict): dictionary for dim_tag_1</span>
<span class="sd">                * c_o_m(float): Center of mass for dim_tag_1</span>
<span class="sd">                * bbox(float): Bounding box for dim_tag_1</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>

<span class="sd">            * dim_tag_n(dict): dictionary for dim_tag_n</span>
<span class="sd">                * c_o_m(float): Center of mass for dim_tag_n</span>
<span class="sd">                * bbox(float): Bounding box for dim_tag_n</span>

<span class="sd">        dim(int): dimension of the searched shapes</span>

<span class="sd">    Returns:</span>
<span class="sd">        dim_tagMap(dict):</span>
<span class="sd">            * dim_tag_1(int, int): a dim_tag(int, int) in the current model</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>

<span class="sd">            * dim_tag_n(int, int): a dim_tag(int, int) in the current model</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outdim_tags</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">dim_tagMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">geom_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">geom_info</span><span class="p">[</span><span class="n">dim_tag</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">outdim_tag</span> <span class="ow">in</span> <span class="n">outdim_tags</span><span class="p">:</span>
            <span class="n">outbbox</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">outdim_tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">outbbox</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
                <span class="n">dim_tagMap</span><span class="p">[</span><span class="n">dim_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">outdim_tag</span>

    <span class="k">return</span> <span class="n">dim_tagMap</span></div>

<div class="viewcode-block" id="dtmap"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.dtmap">[docs]</a><span class="k">def</span> <span class="nf">dtmap</span><span class="p">(</span><span class="n">dim_tagMap</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a map old dim_tags-&gt;dim_tags in the current model.</span>

<span class="sd">    Args:</span>
<span class="sd">        dim_tagMap(dict):</span>
<span class="sd">            * dim_tag_1(int, int): a dim_tag(int, int) in the current model</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>
<span class="sd">                * .</span>

<span class="sd">            * dim_tag_n(int, int): a dim_tag(int, int) in the current model</span>

<span class="sd">        dim_tags(list(int, int)): a list of dim_tags of the entities:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">    Returns:</span>
<span class="sd">        outdim_tags(list(int, int)): a list of dim_tags in the current model based on the old dim_tags and the</span>
<span class="sd">            dim_tagMap -mapping: dimTag (as called in Gmsh) is a tuple of:</span>
<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapped_dim_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim_tagMap</span><span class="p">[</span><span class="n">dim_tag</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">dim_tags</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">(</span><span class="n">mapped_dim_tags</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_mesh_size"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.set_mesh_size">[docs]</a><span class="k">def</span> <span class="nf">set_mesh_size</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">min_mesh_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_mesh_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dist_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">sampling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the mesh size such that it is `min_mesh_size` when near the curves of boundaries defined by the entities of</span>
<span class="sd">    dim_tags and gradually increasing to `max_mesh_size`.</span>

<span class="sd">    .. code-block:: text</span>

<span class="sd">      max_mesh_size -                     /------------------</span>
<span class="sd">                                         /</span>
<span class="sd">                                        /</span>
<span class="sd">                                       /</span>
<span class="sd">      min_mesh_size -o----------------/</span>
<span class="sd">                     |                |    |</span>
<span class="sd">                  Point         dist_min  dist_max</span>

<span class="sd">    Args:</span>

<span class="sd">        dim_tags(list(int, int)): a list of BOUNDARY dim_tags:</span>
<span class="sd">            dimTag (as called in Gmsh) is a tuple of</span>

<span class="sd">                * dimension(int): the dimension of the entity (0=point, 1=line, 2=surface, 3=volume)</span>
<span class="sd">                * tag(int): the id of the entity</span>

<span class="sd">        min_mesh_size(float): minimum mesh size</span>
<span class="sd">        max_mesh_size(float): maximum mesh size</span>
<span class="sd">        dist_min(float): distance to which the minimum mesh size is used</span>
<span class="sd">        dist_max(float): distance after which the maximum mesh size is used</span>
<span class="sd">        sampling(fload): number of sampling points when computing the distance from the curve. The default</span>
<span class="sd">                         value is None. In that case the value is determined by 1.5 times the maximum reachable</span>
<span class="sd">                         distance in the bounding box of the entity (curve) divided by the minimum mesh size. At</span>
<span class="sd">                         the moment there is no obvious way to implement curve_length/min_mesh_size type of</span>
<span class="sd">                         algorithm.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tag_threshold_fields(list(int)): tag list of the threshold fields that were defined in this function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outdim_tags</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oriented</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># search points</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">outdim_tags</span><span class="p">,</span> <span class="n">min_mesh_size</span><span class="p">)</span>

    <span class="n">outdim_tags</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">(</span><span class="n">dim_tags</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oriented</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># search lines</span>

    <span class="n">tag_threshold_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">sampling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">outdim_tags</span><span class="p">:</span>
            <span class="n">curve</span> <span class="o">=</span> <span class="n">dim_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tag_distance_field</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Distance&quot;</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumbers</span><span class="p">(</span><span class="n">tag_distance_field</span><span class="p">,</span> <span class="s2">&quot;CurvesList&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">curve</span><span class="p">])</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">)</span>
            <span class="n">bbox_maxdist</span> <span class="o">=</span> <span class="n">coord_dist</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">sampling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">bbox_maxdist</span><span class="o">/</span><span class="n">min_mesh_size</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_distance_field</span><span class="p">,</span> <span class="s2">&quot;Sampling&quot;</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span>
            <span class="n">tag_threshold_field</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Threshold&quot;</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;InField&quot;</span><span class="p">,</span> <span class="n">tag_distance_field</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;SizeMin&quot;</span><span class="p">,</span> <span class="n">min_mesh_size</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;SizeMax&quot;</span><span class="p">,</span> <span class="n">max_mesh_size</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;DistMin&quot;</span><span class="p">,</span> <span class="n">dist_min</span><span class="p">)</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;DistMax&quot;</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">)</span>
            <span class="n">tag_threshold_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curve_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">outdim_tags</span><span class="p">]</span>
        <span class="n">tag_distance_field</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Distance&quot;</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumbers</span><span class="p">(</span><span class="n">tag_distance_field</span><span class="p">,</span> <span class="s2">&quot;CurvesList&quot;</span><span class="p">,</span> <span class="n">curve_list</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_distance_field</span><span class="p">,</span> <span class="s2">&quot;Sampling&quot;</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span>
        <span class="n">tag_threshold_field</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Threshold&quot;</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;InField&quot;</span><span class="p">,</span> <span class="n">tag_distance_field</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;SizeMin&quot;</span><span class="p">,</span> <span class="n">min_mesh_size</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;SizeMax&quot;</span><span class="p">,</span> <span class="n">max_mesh_size</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;DistMin&quot;</span><span class="p">,</span> <span class="n">dist_min</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">,</span> <span class="s2">&quot;DistMax&quot;</span><span class="p">,</span> <span class="n">dist_max</span><span class="p">)</span>
        <span class="n">tag_threshold_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_threshold_field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tag_threshold_fields</span></div>

<div class="viewcode-block" id="add_port"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.add_port">[docs]</a><span class="k">def</span> <span class="nf">add_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a port polygon to the model, sets the signal and ground ids and returns the port dim_tag.</span>

<span class="sd">    Args:</span>
<span class="sd">        port(simulation.port): a port defined in the `Simulation` class.</span>
<span class="sd">        mesh_size(float): mesh size can be given to the points (note that these points are not used in the final mesh in</span>
<span class="sd">                          case the boolean operations are used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dim_tag: DimTag of the port polygon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">line_ids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">surface_id</span> <span class="o">=</span> <span class="n">add_polygon</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;polygon&#39;</span><span class="p">],</span> <span class="n">mesh_size</span><span class="p">)</span>
    <span class="n">port</span><span class="p">[</span><span class="s1">&#39;dim_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">surface_id</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;InternalPort&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line_id</span> <span class="ow">in</span> <span class="n">line_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_id</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_edge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> \
               <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_id</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_edge&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">signal_id</span> <span class="o">=</span> <span class="n">line_id</span>
            <span class="k">elif</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_id</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;ground_edge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> \
                    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">line_id</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;ground_edge&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ground_id</span> <span class="o">=</span> <span class="n">line_id</span>

        <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_edge_dim_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">signal_id</span><span class="p">)</span>
        <span class="n">port</span><span class="p">[</span><span class="s1">&#39;ground_edge_dim_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ground_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;dim_tag&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="get_bbox_sides_as_bboxes"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.get_bbox_sides_as_bboxes">[docs]</a><span class="k">def</span> <span class="nf">get_bbox_sides_as_bboxes</span><span class="p">(</span><span class="n">bbox</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the sides of a bounding box in a bounding box format.</span>

<span class="sd">    Args:</span>
<span class="sd">        bbox(list): list of floats describing one bounding box</span>

<span class="sd">            * xmin(float): minimum x-coordinate of the bounding box</span>
<span class="sd">            * ymin(float): minimum y-coordinate of the bounding box</span>
<span class="sd">            * zmin(float): minimum z-coordinate of the bounding box</span>
<span class="sd">            * xmax(float): maximum x-coordinate of the bounding box</span>
<span class="sd">            * ymax(float): maximum y-coordinate of the bounding box</span>
<span class="sd">            * zmax(float): maximum z-coordinate of the bounding box</span>

<span class="sd">    Returns:</span>
<span class="sd">        (dict): each value in a format as the input argument `bbox`</span>

<span class="sd">            * xmin: bounding box of the side where x is xmin</span>
<span class="sd">            * xmax: bounding box of the side where x is xmax</span>
<span class="sd">            * ymin: bounding box of the side where y is ymin</span>
<span class="sd">            * ymax: bounding box of the side where y is ymax</span>
<span class="sd">            * zmin: bounding box of the side where z is zmin</span>
<span class="sd">            * zmax: bounding box of the side where z is zmax</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">bbox</span>
    <span class="n">sides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;xmin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">),</span>
        <span class="s1">&#39;xmax&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">),</span>
        <span class="s1">&#39;ymin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">),</span>
        <span class="s1">&#39;ymax&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">),</span>
        <span class="s1">&#39;zmin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">),</span>
        <span class="s1">&#39;zmax&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sides</span></div>

<div class="viewcode-block" id="export_gmsh_msh"><a class="viewcode-back" href="../../../../api/kqcircuits.simulations.export.gmsh_helpers.html#kqcircuits.simulations.export.gmsh_helpers.export_gmsh_msh">[docs]</a><span class="k">def</span> <span class="nf">export_gmsh_msh</span><span class="p">(</span><span class="n">simulation</span><span class="p">:</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                    <span class="n">default_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">signal_min_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">signal_max_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">signal_min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">signal_max_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">signal_sampling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">ground_min_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_max_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_max_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_sampling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">ground_grid_min_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_grid_max_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_grid_min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_grid_max_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">ground_grid_sampling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">gap_min_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">gap_max_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">gap_min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">gap_max_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">gap_sampling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">port_min_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">port_max_mesh_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">port_min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">port_max_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                    <span class="n">port_sampling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">algorithm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds the model using OpenCASCADE kernel and exports the result in &quot;simulation.msh&quot;</span>
<span class="sd">    file in the specified simulation `path`</span>

<span class="sd">    Args:</span>

<span class="sd">        simulation(Simulation): The simulation to be exported</span>
<span class="sd">        path(Path): path of the simulation export folder</span>
<span class="sd">        default_mesh_size(float): Default size to be used where not defined</span>
<span class="sd">        signal_min_mesh_size(float): Minimum mesh size near signal region curves</span>
<span class="sd">        signal_max_mesh_size(float): Maximum mesh size near signal region curves</span>
<span class="sd">        signal_min_dist(float): Mesh size will be the minimum size until this distance</span>
<span class="sd">                                from the signal region curves</span>
<span class="sd">        signal_max_dist(float): Mesh size will grow from to the maximum size until</span>
<span class="sd">                                this distance from the signal region curves</span>
<span class="sd">        signal_sampling(float): Number of points used for sampling each signal region curve</span>
<span class="sd">        ground_min_mesh_size(float): Minimum mesh size near ground region curves</span>
<span class="sd">        ground_max_mesh_size(float): Maximum mesh size near ground region curves</span>
<span class="sd">        ground_min_dist(float): Mesh size will be the minimum size until this distance</span>
<span class="sd">                                from the ground region curves</span>
<span class="sd">        ground_max_dist(float): Mesh size will grow from to the maximum size until</span>
<span class="sd">                                this distance from the ground region curves</span>
<span class="sd">        ground_sampling(float): Number of points used for sampling each ground region curve</span>
<span class="sd">        ground_grid_min_mesh_size(float): Minimum mesh size near ground_grid region curves</span>
<span class="sd">        ground_grid_max_mesh_size(float): Maximum mesh size near ground_grid region curves</span>
<span class="sd">        ground_grid_min_dist(float): Mesh size will be the minimum size until this distance</span>
<span class="sd">                                from the ground_grid region curves</span>
<span class="sd">        ground_grid_max_dist(float): Mesh size will grow from to the maximum size until</span>
<span class="sd">                                this distance from the ground_grid region curves</span>
<span class="sd">        ground_grid_sampling(float): Number of points used for sampling each ground_grid region curve</span>
<span class="sd">        gap_min_mesh_size(float): Minimum mesh size near gap region curves</span>
<span class="sd">        gap_max_mesh_size(float): Maximum mesh size near gap region curves</span>
<span class="sd">        gap_min_dist(float): Mesh size will be the minimum size until this distance</span>
<span class="sd">                                from the gap region curves</span>
<span class="sd">        gap_max_dist(float): Mesh size will grow from to the maximum size until</span>
<span class="sd">                                this distance from the gap region curves</span>
<span class="sd">        gap_sampling(float): Number of points used for sampling each gap region curve</span>
<span class="sd">        port_min_mesh_size(float): Minimum mesh size near port region curves</span>
<span class="sd">        port_max_mesh_size(float): Maximum mesh size near port region curves</span>
<span class="sd">        port_min_dist(float): Mesh size will be the minimum size until this distance</span>
<span class="sd">                                from the port region curves</span>
<span class="sd">        port_max_dist(float): Mesh size will grow from to the maximum size until</span>
<span class="sd">                                this distance from the port region curves</span>
<span class="sd">        port_sampling(float): Number of points used for sampling each port region curve</span>
<span class="sd">        algorithm(float): Gmsh meshing algorithm (default is 5)</span>
<span class="sd">        show(float): Show the mesh in Gmsh graphical interface after completing the mesh</span>
<span class="sd">                     (for large meshes this can take a long time)</span>

<span class="sd">    Returns:</span>

<span class="sd">        tuple:</span>

<span class="sd">             * filepath(Path): Path to exported msh file</span>
<span class="sd">             * port_data_gmsh(list):</span>

<span class="sd">                 each element contain port data that one gets from `Simulation.get_port_data` + gmsh specific data:</span>

<span class="sd">                    * Items from `Simulation.get_port_data`</span>
<span class="sd">                    * dim_tag: DimTags of the port polygons</span>
<span class="sd">                    * occ_bounding_box: port bounding box</span>
<span class="sd">                    * dim_tags: list of DimTags if the port consist of more than one (`EdgePort`)</span>
<span class="sd">                    * signal_dim_tag: DimTag of the face that is connected to the signal edge of the port</span>
<span class="sd">                    * signal_physical_name: physical name of the signal face</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.msh&#39;</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">edge_dim_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">port_data_gmsh</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">get_port_data</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">simulation</span><span class="o">.</span><span class="n">wafer_stack_type</span> <span class="o">==</span> <span class="s1">&#39;multiface&#39;</span><span class="p">:</span>
        <span class="n">chip_distance</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">chip_distance</span>
        <span class="n">face_ids</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">face_ids</span>
        <span class="n">face_z_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">chip_distance</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">face_ids</span><span class="p">]</span>
        <span class="n">chip_dzs</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">simulation</span><span class="o">.</span><span class="n">substrate_height</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span> <span class="k">else</span> <span class="n">simulation</span><span class="o">.</span><span class="n">substrate_height_top</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">face_ids</span><span class="p">]</span>
        <span class="n">face_port_dim_tags</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
        <span class="n">edge_port_dim_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_data_gmsh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;InternalPort&#39;</span><span class="p">:</span>
                <span class="n">face_port_dim_tags</span><span class="p">[</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;face&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port_min_mesh_size</span><span class="p">))</span>
                <span class="n">edge_dim_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_edge_dim_tag&#39;</span><span class="p">])</span>
                <span class="n">edge_dim_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;ground_edge_dim_tag&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edge_port_dim_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_port</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">port_min_mesh_size</span><span class="p">))</span>
                <span class="n">port</span><span class="p">[</span><span class="s1">&#39;occ_bounding_box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;dim_tag&#39;</span><span class="p">])</span>
                <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_location_float&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">face_z_levels</span><span class="p">[</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;face&#39;</span><span class="p">]]</span>

        <span class="n">face_dim_tag_dicts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">face_dim_tag_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_face</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">face_z_levels</span><span class="p">[</span><span class="n">face</span><span class="p">],</span> <span class="n">simulation</span><span class="p">,</span>
                                                <span class="n">port_dim_tags</span><span class="o">=</span><span class="n">face_port_dim_tags</span><span class="p">[</span><span class="n">face</span><span class="p">]))</span>

        <span class="n">chip0</span> <span class="o">=</span> <span class="n">substrate</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip_dzs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">chip1</span> <span class="o">=</span> <span class="n">substrate</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chip_dzs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vacuum</span> <span class="o">=</span> <span class="n">vacuum_between_faces</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ground&#39;</span><span class="p">],</span> <span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ground&#39;</span><span class="p">])</span>
        <span class="n">face0_dim_tags</span> <span class="o">=</span> <span class="n">face_tag_dict_to_list</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">face1_dim_tags</span> <span class="o">=</span> <span class="n">face_tag_dict_to_list</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">all_dim_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">chip0</span><span class="p">,</span> <span class="n">chip1</span><span class="p">,</span> <span class="n">vacuum</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">face0_dim_tags</span> <span class="o">+</span> <span class="n">face1_dim_tags</span>
                                                 <span class="o">+</span> <span class="n">face_port_dim_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">face_port_dim_tags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edge_port_dim_tags</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
        <span class="n">out_all_dim_tags</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">fragment</span><span class="p">(</span><span class="n">all_dim_tags</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntities</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">default_mesh_size</span><span class="p">)</span>
        <span class="n">mesh_field_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">mesh_field_ids</span> <span class="o">+=</span> <span class="n">set_mesh_size</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="n">face</span><span class="p">][</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
                    <span class="n">signal_min_mesh_size</span><span class="p">,</span> <span class="n">signal_max_mesh_size</span><span class="p">,</span> <span class="n">signal_min_dist</span><span class="p">,</span> <span class="n">signal_max_dist</span><span class="p">,</span> <span class="n">signal_sampling</span><span class="p">)</span>
            <span class="n">mesh_field_ids</span> <span class="o">+=</span> <span class="n">set_mesh_size</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="n">face</span><span class="p">][</span><span class="s1">&#39;ground&#39;</span><span class="p">],</span>
                    <span class="n">ground_min_mesh_size</span><span class="p">,</span> <span class="n">ground_max_mesh_size</span><span class="p">,</span> <span class="n">ground_min_dist</span><span class="p">,</span> <span class="n">ground_max_dist</span><span class="p">,</span> <span class="n">ground_sampling</span><span class="p">)</span>
            <span class="n">mesh_field_ids</span> <span class="o">+=</span> <span class="n">set_mesh_size</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="n">face</span><span class="p">][</span><span class="s1">&#39;gap&#39;</span><span class="p">],</span>
                    <span class="n">gap_min_mesh_size</span><span class="p">,</span> <span class="n">gap_max_mesh_size</span><span class="p">,</span> <span class="n">gap_min_dist</span><span class="p">,</span> <span class="n">gap_max_dist</span><span class="p">,</span> <span class="n">gap_sampling</span><span class="p">)</span>
            <span class="n">mesh_field_ids</span> <span class="o">+=</span> <span class="n">set_mesh_size</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="n">face</span><span class="p">][</span><span class="s1">&#39;ground_grid&#39;</span><span class="p">],</span> <span class="n">ground_grid_min_mesh_size</span><span class="p">,</span>
                    <span class="n">ground_grid_max_mesh_size</span><span class="p">,</span> <span class="n">ground_grid_min_dist</span><span class="p">,</span> <span class="n">ground_grid_max_dist</span><span class="p">,</span> <span class="n">ground_grid_sampling</span><span class="p">)</span>
            <span class="n">mesh_field_ids</span> <span class="o">+=</span> <span class="n">set_mesh_size</span><span class="p">(</span><span class="n">face_port_dim_tags</span><span class="p">[</span><span class="n">face</span><span class="p">],</span>
                    <span class="n">port_min_mesh_size</span><span class="p">,</span> <span class="n">port_max_mesh_size</span><span class="p">,</span> <span class="n">port_min_dist</span><span class="p">,</span> <span class="n">port_max_dist</span><span class="p">,</span> <span class="n">port_sampling</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">face_dim_tag_dict</span> <span class="ow">in</span> <span class="n">face_dim_tag_dicts</span><span class="p">:</span>
            <span class="n">face_signal_dim_tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">face_dim_tag_dict</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">port_data_gmsh</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;InternalPort&#39;</span><span class="p">:</span>
                    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;dim_tag&#39;</span><span class="p">],</span> <span class="s1">&#39;port_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]))</span>

                    <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">face_signal_dim_tags</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_edge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span>\
                           <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_edge&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_dim_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_tag</span>
                            <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_physical_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;signal_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
                            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_physical_name&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">port</span><span class="p">[</span><span class="s1">&#39;dim_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_entities_in_bounding_boxes</span><span class="p">([</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;occ_bounding_box&#39;</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;dim_tags&#39;</span><span class="p">]):</span>
                        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="s1">&#39;port_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="n">face_signal_dim_tags</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">isInside</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_location_float&#39;</span><span class="p">]):</span>
                            <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_dim_tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_tag</span>
                            <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_physical_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;signal_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
                            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="s1">&#39;signal_physical_name&#39;</span><span class="p">])</span>

        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">chip0</span><span class="p">,</span> <span class="s1">&#39;chip_0&#39;</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">chip1</span><span class="p">,</span> <span class="s1">&#39;chip_1&#39;</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">vacuum</span><span class="p">,</span> <span class="s1">&#39;vacuum&#39;</span><span class="p">)</span>

    <span class="c1"># Find all the extreme boundaries and add physical names to them</span>
    <span class="n">bbox_all</span> <span class="o">=</span> <span class="n">bounding_box_from_dim_tags</span><span class="p">(</span><span class="n">out_all_dim_tags</span><span class="p">)</span>
    <span class="n">bbox_all_sides</span> <span class="o">=</span> <span class="n">get_bbox_sides_as_bboxes</span><span class="p">(</span><span class="n">bbox_all</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">side_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xmin&#39;</span><span class="p">,</span> <span class="s1">&#39;ymin&#39;</span><span class="p">,</span> <span class="s1">&#39;zmin&#39;</span><span class="p">,</span> <span class="s1">&#39;xmax&#39;</span><span class="p">,</span> <span class="s1">&#39;ymax&#39;</span><span class="p">,</span> <span class="s1">&#39;zmax&#39;</span><span class="p">]:</span>
        <span class="n">bbox_all_dim_tags</span> <span class="o">=</span> <span class="n">get_entities_in_bounding_boxes</span><span class="p">([</span><span class="n">bbox_all_sides</span><span class="p">[</span><span class="n">side_name</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bbox_all_dim_tags</span><span class="p">):</span>
            <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">side_name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

    <span class="n">simulation</span><span class="o">.</span><span class="n">ground_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim_tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ground&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">face_dim_tag_dicts</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ground&#39;</span><span class="p">]):</span>
        <span class="n">ground_name</span> <span class="o">=</span> <span class="s1">&#39;ground_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="o">*</span><span class="n">dim_tag</span><span class="p">,</span> <span class="n">ground_name</span><span class="p">)</span>
        <span class="n">simulation</span><span class="o">.</span><span class="n">ground_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ground_name</span><span class="p">)</span>

    <span class="n">background_field_id</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Min&quot;</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumbers</span><span class="p">(</span><span class="n">background_field_id</span><span class="p">,</span> <span class="s2">&quot;FieldsList&quot;</span><span class="p">,</span> <span class="n">mesh_field_ids</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setAsBackgroundMesh</span><span class="p">(</span><span class="n">background_field_id</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MeshSizeExtendFromBoundary&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MeshSizeFromPoints&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MeshSizeFromCurvature&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.Algorithm&quot;</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.ToleranceInitialDelaunay&quot;</span><span class="p">,</span> <span class="mf">1e-14</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">fltk</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">port_data_gmsh</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021-2022, IQM.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>